{"remainingRequest":"C:\\Users\\kprut\\Desktop\\ask-around-me\\frontend\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\Users\\kprut\\Desktop\\ask-around-me\\frontend\\src\\components\\IoT.vue?vue&type=script&lang=js&","dependencies":[{"path":"C:\\Users\\kprut\\Desktop\\ask-around-me\\frontend\\src\\components\\IoT.vue","mtime":1607093321477},{"path":"C:\\Users\\kprut\\Desktop\\ask-around-me\\frontend\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\kprut\\Desktop\\ask-around-me\\frontend\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"C:\\Users\\kprut\\Desktop\\ask-around-me\\frontend\\node_modules\\vuetify-loader\\lib\\loader.js","mtime":1574476662000},{"path":"C:\\Users\\kprut\\Desktop\\ask-around-me\\frontend\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\kprut\\Desktop\\ask-around-me\\frontend\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KCmltcG9ydCB7IG1hcFN0YXRlIH0gZnJvbSAndnVleCcKbGV0IG1xdHRDbGllbnQKCmV4cG9ydCBkZWZhdWx0IHsKICBuYW1lOiAnSW9UJywKICBjb21wdXRlZDogewogICAgLi4ubWFwU3RhdGUoewogICAgICBpbml0OiAoc3RhdGUpID0+IHN0YXRlLmluaXRpYWxpemVkLAogICAgICBoYXNoOiAoc3RhdGUpID0+IHN0YXRlLmhhc2hLZXkKICAgIH0pCiAgfSwKICB3YXRjaDogewogICAgLy8gVGhlIGVmZmVjdCBvZiB0aGlzIGlzIHRvIHdhaXQgdW50aWwgdGhlIHVzZXIgaXMgbG9nZ2VkCiAgICAvLyBpbiBiZWZvcmUgbWFraW5nIHRoZSB3ZWJzb2NrZXQgY29ubmVjdGlvbi4KICAgIGluaXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaW5pdCkgewogICAgICAgIHRoaXMubW91bnRJT1QoKQogICAgICAgIGNvbnNvbGUubG9nKCdNb3VudGluZyB3ZWJzb2NrZXQnKQogICAgICB9CiAgICB9LAogICAgaGFzaDogZnVuY3Rpb24oKSB7CiAgICAgIGNvbnNvbGUubG9nKCdJb1Qgc3Vic2NyaWJpbmcgdG8gJywgdGhpcy5oYXNoKQogICAgICB0aGlzLnN1YnNjcmliZSh0aGlzLmhhc2gpCiAgICB9CiAgfSwKICBtZXRob2RzOiB7CiAgICBzdWJzY3JpYmUgKHRvcGljKSB7CiAgICAgIGNvbnNvbGUubG9nKCdJb1Qgc3ViY3JpYmluZyB0byAnLCB0b3BpYykKICAgICAgbXF0dENsaWVudC5zdWJzY3JpYmUodG9waWMpCiAgICB9LAogICAgbW91bnRJT1QgKCkgewogICAgICBsZXQgX3N0b3JlID0gdGhpcy4kc3RvcmUKCiAgICAgIGNvbnN0IEFXUyA9IHJlcXVpcmUoJ2F3cy1zZGsnKQogICAgICBjb25zdCBBV1NJb1REYXRhID0gcmVxdWlyZSgnYXdzLWlvdC1kZXZpY2Utc2RrJykKICAgICAgbGV0IGVycm9yQ291bnQgPSAwCgogICAgICBjb25zdCBBV1NDb25maWd1cmF0aW9uID0gewogICAgICAgIHBvb2xJZDogdGhpcy4kcG9vbElkLCAvLyd1cy1lYXN0LTE6ZTQ4MDNkM2ItNDJkNS00OTZmLTljNWEtNDA4ZjIwZWIyOGU0JywgLy8gJ1lvdXJDb2duaXRvSWRlbnRpdHlQb29sSWQnCiAgICAgICAgaG9zdDogdGhpcy4kaG9zdCwgLy8gJ1lvdXJBd3NJb1RFbmRwb2ludCcsIGUuZy4gJ3ByZWZpeC5pb3QudXMtZWFzdC0xLmFtYXpvbmF3cy5jb20nCiAgICAgICAgcmVnaW9uOiB0aGlzLiRyZWdpb24gLy8gJ1lvdXJBd3NSZWdpb24nLCBlLmcuICd1cy1lYXN0LTEnCiAgICAgIH0KCiAgICAgIHZhciBjdXJyZW50bHlTdWJzY3JpYmVkVG9waWMgPSAnbmV3LWFuc3dlcicKICAgICAgdmFyIGNsaWVudElkID0gJ2Fza0Fyb3VuZE1lLScgKyAoTWF0aC5mbG9vcigoTWF0aC5yYW5kb20oKSAqIDEwMDAwMCkgKyAxKSkKICAgICAgQVdTLmNvbmZpZy5yZWdpb24gPSBBV1NDb25maWd1cmF0aW9uLnJlZ2lvbgoKICAgICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ29nbml0b0lkZW50aXR5Q3JlZGVudGlhbHMoewogICAgICAgIElkZW50aXR5UG9vbElkOiBBV1NDb25maWd1cmF0aW9uLnBvb2xJZAogICAgICB9KQoKICAgICAgY29uc29sZS5sb2coJ0lvVCBjcmVhdGVkJykKICAgICAgbXF0dENsaWVudCA9IEFXU0lvVERhdGEuZGV2aWNlKHsKICAgICAgICByZWdpb246IEFXUy5jb25maWcucmVnaW9uLAogICAgICAgIGhvc3Q6IEFXU0NvbmZpZ3VyYXRpb24uaG9zdCwKICAgICAgICBjbGllbnRJZDogY2xpZW50SWQsCiAgICAgICAgcHJvdG9jb2w6ICd3c3MnLAogICAgICAgIG1heGltdW1SZWNvbm5lY3RUaW1lTXM6IDgwMDAsCiAgICAgICAgZGVidWc6IGZhbHNlLAogICAgICAgIGFjY2Vzc0tleUlkOiAnJywKICAgICAgICBzZWNyZXRLZXk6ICcnLAogICAgICAgIHNlc3Npb25Ub2tlbjogJycKICAgICAgfSkKCiAgICAgIGNvbnN0IGNvZ25pdG9JZGVudGl0eSA9IG5ldyBBV1MuQ29nbml0b0lkZW50aXR5KCkKICAgICAgY29uc3QgZ2V0Q3JlZHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscy5nZXQoZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ3JldHJpZXZlZCBpZGVudGl0eTogJyArIEFXUy5jb25maWcuY3JlZGVudGlhbHMuaWRlbnRpdHlJZCwgZGF0YSkKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgIElkZW50aXR5SWQ6IEFXUy5jb25maWcuY3JlZGVudGlhbHMuaWRlbnRpdHlJZAogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5KHBhcmFtcywgZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICAgICAgICBtcXR0Q2xpZW50LnVwZGF0ZVdlYlNvY2tldENyZWRlbnRpYWxzKGRhdGEuQ3JlZGVudGlhbHMuQWNjZXNzS2V5SWQsCiAgICAgICAgICAgICAgICAgIGRhdGEuQ3JlZGVudGlhbHMuU2VjcmV0S2V5LAogICAgICAgICAgICAgICAgICBkYXRhLkNyZWRlbnRpYWxzLlNlc3Npb25Ub2tlbikKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2Vycm9yIHJldHJpZXZpbmcgY3JlZGVudGlhbHM6ICcgKyBlcnIpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2Vycm9yIHJldHJpZXZpbmcgaWRlbnRpdHk6JyArIGVycikKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9CgogICAgICBtcXR0Q2xpZW50Lm9uKCdjb25uZWN0JywgZnVuY3Rpb24gKCkgewogICAgICAgIGNvbnNvbGUubG9nKCdtcXR0Q2xpZW50IGNvbm5lY3RlZCcpCiAgICAgICAgbXF0dENsaWVudC5zdWJzY3JpYmUoY3VycmVudGx5U3Vic2NyaWJlZFRvcGljKQogICAgICB9KQoKICAgICAgbXF0dENsaWVudC5vbignZXJyb3InLCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgaWYgKGVycm9yQ291bnQgPiAwKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnbXF0dENsaWVudCBlcnJvcjonLCBlcnIpCiAgICAgICAgfQogICAgICAgIGVycm9yQ291bnQrKwogICAgICAgIGdldENyZWRzKCkKICAgICAgfSkKCiAgICAgIG1xdHRDbGllbnQub24oJ21lc3NhZ2UnLCBmdW5jdGlvbiAodG9waWMsIHBheWxvYWQpIHsKICAgICAgICBjb25zdCBtc2cgPSBKU09OLnBhcnNlKHBheWxvYWQudG9TdHJpbmcoKSkKICAgICAgICBjb25zb2xlLmxvZygnSW9UIG1zZzogJywgdG9waWMsIG1zZykKICAgICAgICBpZiAodG9waWMgPT09ICduZXctYW5zd2VyJykgewogICAgICAgICAgY29uc29sZS5sb2coJ3VwZGF0ZScpCiAgICAgICAgICBfc3RvcmUuY29tbWl0KCd1cGRhdGVRdWVzdGlvbicsIG1zZykKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS5sb2coJ05ldyBxdWVzdGlvbicpCiAgICAgICAgICBfc3RvcmUuY29tbWl0KCdzYXZlUXVlc3Rpb24nLCBtc2cpCiAgICAgICAgfQogICAgICB9KQogICAgfQogIH0KfQo="},{"version":3,"sources":["IoT.vue"],"names":[],"mappings":";;;;;AAKA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"IoT.vue","sourceRoot":"src/components","sourcesContent":["<template>\r\n  <div></div>\r\n</template>\r\n\r\n<script>\r\n  import { mapState } from 'vuex'\r\n  let mqttClient\r\n\r\n  export default {\r\n    name: 'IoT',\r\n    computed: {\r\n      ...mapState({\r\n        init: (state) => state.initialized,\r\n        hash: (state) => state.hashKey\r\n      })\r\n    },\r\n    watch: {\r\n      // The effect of this is to wait until the user is logged\r\n      // in before making the websocket connection.\r\n      init: function () {\r\n        if (this.init) {\r\n          this.mountIOT()\r\n          console.log('Mounting websocket')\r\n        }\r\n      },\r\n      hash: function() {\r\n        console.log('IoT subscribing to ', this.hash)\r\n        this.subscribe(this.hash)\r\n      }\r\n    },\r\n    methods: {\r\n      subscribe (topic) {\r\n        console.log('IoT subcribing to ', topic)\r\n        mqttClient.subscribe(topic)\r\n      },\r\n      mountIOT () {\r\n        let _store = this.$store\r\n\r\n        const AWS = require('aws-sdk')\r\n        const AWSIoTData = require('aws-iot-device-sdk')\r\n        let errorCount = 0\r\n\r\n        const AWSConfiguration = {\r\n          poolId: this.$poolId, //'us-east-1:e4803d3b-42d5-496f-9c5a-408f20eb28e4', // 'YourCognitoIdentityPoolId'\r\n          host: this.$host, // 'YourAwsIoTEndpoint', e.g. 'prefix.iot.us-east-1.amazonaws.com'\r\n          region: this.$region // 'YourAwsRegion', e.g. 'us-east-1'\r\n        }\r\n\r\n        var currentlySubscribedTopic = 'new-answer'\r\n        var clientId = 'askAroundMe-' + (Math.floor((Math.random() * 100000) + 1))\r\n        AWS.config.region = AWSConfiguration.region\r\n\r\n        AWS.config.credentials = new AWS.CognitoIdentityCredentials({\r\n          IdentityPoolId: AWSConfiguration.poolId\r\n        })\r\n\r\n        console.log('IoT created')\r\n        mqttClient = AWSIoTData.device({\r\n          region: AWS.config.region,\r\n          host: AWSConfiguration.host,\r\n          clientId: clientId,\r\n          protocol: 'wss',\r\n          maximumReconnectTimeMs: 8000,\r\n          debug: false,\r\n          accessKeyId: '',\r\n          secretKey: '',\r\n          sessionToken: ''\r\n        })\r\n\r\n        const cognitoIdentity = new AWS.CognitoIdentity()\r\n        const getCreds = function () {\r\n          AWS.config.credentials.get(function (err, data) {\r\n            if (!err) {\r\n              console.log('retrieved identity: ' + AWS.config.credentials.identityId, data)\r\n              const params = {\r\n                IdentityId: AWS.config.credentials.identityId\r\n              }\r\n              cognitoIdentity.getCredentialsForIdentity(params, function (err, data) {\r\n                if (!err) {\r\n                  mqttClient.updateWebSocketCredentials(data.Credentials.AccessKeyId,\r\n                    data.Credentials.SecretKey,\r\n                    data.Credentials.SessionToken)\r\n                } else {\r\n                  // console.log('error retrieving credentials: ' + err)\r\n                }\r\n              })\r\n            } else {\r\n              // console.log('error retrieving identity:' + err)\r\n            }\r\n          })\r\n        }\r\n\r\n        mqttClient.on('connect', function () {\r\n          console.log('mqttClient connected')\r\n          mqttClient.subscribe(currentlySubscribedTopic)\r\n        })\r\n\r\n        mqttClient.on('error', function (err) {\r\n          if (errorCount > 0) {\r\n            console.log('mqttClient error:', err)\r\n          }\r\n          errorCount++\r\n          getCreds()\r\n        })\r\n\r\n        mqttClient.on('message', function (topic, payload) {\r\n          const msg = JSON.parse(payload.toString())\r\n          console.log('IoT msg: ', topic, msg)\r\n          if (topic === 'new-answer') {\r\n            console.log('update')\r\n            _store.commit('updateQuestion', msg)\r\n          } else {\r\n            console.log('New question')\r\n            _store.commit('saveQuestion', msg)\r\n          }\r\n        })\r\n      }\r\n    }\r\n  }\r\n</script>"]}]}